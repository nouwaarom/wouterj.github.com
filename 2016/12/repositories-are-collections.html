<!doctype html>
<html lang=""><head>
    <meta charset=utf-8>

    <title>Repositories are just Collections ~ Wouter J</title>

    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name=theme-color content=#cc3333>

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:400,400i,700|Oswald|Inconsolata" rel="stylesheet">
    <link rel=stylesheet href="/assets/main.css">
    <link rel=icon type=image/png href=/img/css/favicon.png sizes=96x96><link type="application/atom+xml" rel="alternate" href="https://wouterj.nl/feed.xml" title="Wouter J" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30226315-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body class="page  page--post" itemscope itemtype="http://schema.org/WebPage"><header class=page__header>
    <hgroup class=page__headline>
        <h1 class="site-title" itemprop="name"><a href="/">Wouter J</a></h1>
    </hgroup><nav class=page__nav>
        <ul class="nav  nav--block"><li class="nav__item  "><a href="/categories/article/index.html"><i class=icon>&#xF139;</i> <span class="button__text">Articles</span></a></li><li class="nav__item  "><a href="/categories/news/index.html"><i class=icon>&#xF0CA;</i> <span class="button__text">News</span></a></li><li class="nav__item  "><a href="/categories/opinion/index.html"><i class=icon>&#xF075;</i> <span class="button__text">Opinions</span></a></li><li class="nav__item  "><a href="/categories/experiment/index.html"><i class=icon>&#xF051;</i> <span class="button__text">Experiments</span></a></li></ul>
    </nav></div>
</header>
<div class=page__body itemscope itemtype="http://schema.org/Blog">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    
        <span class="post__category">
        <time class="dt-published" datetime="2016-12-15T00:00:00+00:00" itemprop="datePublished">
            DEC '16
        </time>
        
        
        &#xf139;
        
        </span>
    

    <h1 class="post__heading" itemprop="headline">Repositories are just Collections</h1>

    

    <div itemprop="articleBody">
        <div class="post__excerpt">
            
            <p>Repositories are just collections of things. A post repository is a collection
of posts, a user repository a collection of users. They allow to abstract away
all the persistence details. Yet, many people think of Doctrine repositories as
purely related to Doctrine, leading to strange abstractions. Let’s create a
normal collection with Symfony and Doctrine today!</p></div><div class="post__entry">
      <h2 id="it-all-starts-with-the-interface">
        
        
          <a href="#it-all-starts-with-the-interface" class="section-link"></a> It all starts with the Interface
        
        
      </h2>

<p>When designing your application, start with designing your interfaces. If you
like your interfaces, the implementation will probably be nice as well. In this
post, we’re going to design a collection of products. The interface first
contains some basic collection methods:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// src/AppBundle/Product/ProductRepository.php</span>
<span class="k">namespace</span> <span class="nx">AppBundle\Product</span><span class="p">;</span>

<span class="k">interface</span> <span class="nx">ProductRepository</span> <span class="k">extends</span> <span class="nx">\Countable</span>
<span class="p">{</span>
    <span class="sd">/** @return Product[] */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">all</span><span class="p">();</span>

    <span class="sd">/** @return bool */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">includes</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">);</span>

    <span class="sd">/** @return int */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">count</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We can now count the number of products in the collection, get all products in
the collection and check if a product is included in the collection. Now, let’s
add two simple methods for more specific operations on this collection:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// src/AppBundle/Product/ProductRepository.php</span>

<span class="c1">// ...</span>
<span class="k">interface</span> <span class="nx">ProductRepository</span> <span class="k">extends</span> <span class="nx">\Countable</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">);</span>

    <span class="sd">/** @return null|Product */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">byId</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="a-basic-implementation">
        
        
          <a href="#a-basic-implementation" class="section-link"></a> A Basic Implementation
        
        
      </h2>

<p>The most straight-forward way to implement collections in PHP is by using
arrays. Let’s create an array based product collection:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="c1">// src/AppBundle/Product/ArrayBasedProductRepository.php</span>
<span class="k">namespace</span> <span class="nx">AppBundle\Product</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ArrayBasedProductRepository</span> <span class="k">implements</span> <span class="nx">ProductRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$products</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">all</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">includes</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$product</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">count</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">[</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$product</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">byId</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">[</span><span class="nv">$id</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">products</span><span class="p">[</span><span class="nv">$id</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Most of the methods in the interface can be mapped to simple PHP array
methods. This repository can be defined as a service:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># app/config/services.yml</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="s">app.product_repository</span><span class="pi">:</span>
        <span class="na">class</span><span class="pi">:</span> <span class="s">AppBundle\Product\ArrayBasedProductRepository</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then you can probably imagine how we would use this product collection in a
controller:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="c1">// src/AppBundle/Controller/ShopController.php</span>
<span class="k">namespace</span> <span class="nx">AppBundle\Controller</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ShopController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">listAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$products</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'app.product_repository'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'shop/products.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'products'</span> <span class="o">=&gt;</span> <span class="nv">$products</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">productInfoAction</span><span class="p">(</span><span class="nv">$productId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'app.product_repository'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">byId</span><span class="p">(</span><span class="nv">$productId</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'shop/product_info.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'product'</span> <span class="o">=&gt;</span> <span class="nv">$product</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="using-doctrine">
        
        
          <a href="#using-doctrine" class="section-link"></a> Using Doctrine
        
        
      </h2>

<p>So far, we’ve only looked at normal repositories. I hope this brought the point
across that repositories are just collections. The nice thing about
repositories is that we can implement all sort of different backends for our
collections. As this post is also about Doctrine, let’s create a product
collection based on Doctrine.</p>

<p>The <code class="highlighter-rouge">EntityRepository</code> shipped with the Doctrine ORM is a simple wrapper class
around the entity manager and the unit of work. The class isn’t used in
Doctrine itself, it’s purely an easy starting point for the users. This means
we can completely drop it and base our doctrine collection on top of the entity
manager:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="c1">// src/AppBundle/Product/DoctrineBasedProductRepository.php</span>
<span class="k">namespace</span> <span class="nx">AppBundle\Product</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DoctrineBasedProductRepository</span> <span class="k">implements</span> <span class="nx">ProductRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entityManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">all</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Create a basic DQL query to fetch all entities</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="s1">'SELECT p FROM '</span><span class="o">.</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="o">.</span><span class="s1">' p'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">includes</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Check if the entity is managed by the entity manager</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">contains</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">count</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Create a basic count DQL query</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="s1">'SELECT count(p) FROM '</span><span class="o">.</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="o">.</span><span class="s1">' p'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getSingleScalarResult</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">byId</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Fetch a product by id (note: No need to use DQL or the EntityRepository here either!)</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As you can see, the code in here is just a bit more complex than using the
array repository. Even better, the usage of this repository has not changed a
single bit when comparing it with the <code class="highlighter-rouge">ArrayBasedProductRepository</code>. So we only
have to update the service definitions to use doctrine:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># app/config/services.yml</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="s">app.product_repository</span><span class="pi">:</span>
        <span class="na">class</span><span class="pi">:</span> <span class="s">AppBundle\Product\DoctrineBasedProductRepository</span>
        <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@doctrine.orm.entity_manager'</span><span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>
    
      <h2 id="treat-repositories-as-collections">
        
        
          <a href="#treat-repositories-as-collections" class="section-link"></a> Treat Repositories as Collections
        
        
      </h2>

<p>As I tried to show in this post, treating repositories as collections has some
significant advantages:</p>

<ul>
  <li>The collection implementation is abstracted away, not much hassle with
Doctrine anymore</li>
  <li>All collection methods are located in one class/service. This means you
never has to rely on both the entity repository and manager (in order to
fetch and persist) anymore</li>
  <li>Working with Doctrine as if it’s a collection makes programming easier to
follow</li>
</ul>

<p>My last warning of this post is to not add non-collection related methods in
the repository. I sometimes see people adding <code class="highlighter-rouge">getXxxQuery()</code> methods in the
repository, as e.g. the form type requires you to set a query. These methods
tell something about the implementation. They are no longer related to
collections (try to think what this method should return in the
<code class="highlighter-rouge">ArrayBasedProductRepository</code>).</p>
    
      <h2 id="take-homes">
        
        
          <a href="#take-homes" class="section-link"></a> Take Home’s
        
        
      </h2>

<ul>
  <li>The <code class="highlighter-rouge">EntityRepository</code> class shipped by Doctrine is purely to ease usage,
it’s not mandatory at all</li>
  <li>Writing your own repositories allow you to abstract away Doctrine almost
completely from your services and controllers</li>
  <li>Repositories are just collections, please treat them as such</li>
</ul>

        </div>
    </div><div id="disqus_thread" class="post__comments" itemprop="comment"></div>
    <script>
    var disqus_config = function () {
        this.page.url = 'https://wouterj.nl/2016/12/repositories-are-collections';
        this.page.identifier = 'https://wouterj.nl/2016/12/repositories-are-collections';
        this.page.title = 'Repositories are just Collections';
    };

    (function() {
        var d = document, s = d.createElement('script');

        s.src = 'https://wouterjnl.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></article>

    </main><footer class="page__footer">
    <p>&copy; Copyright 2012 - 2019 Wouter de Jong</p>
</footer>
</body>

</html>
